<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="appTitle">ポイント制 抽選ツール</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="wrap">
    <header class="appbar">
      <div class="title" data-i18n="appTitle">ポイント制 抽選ツール</div>
      <div class="toolbar">
        <button id="btnFormat" class="btn secondary" title="リスト整形ツール" data-i18n="formatTool">🧹 整形</button>
        <button id="btnSave" class="btn ghost" title="現在の設定を保存" data-i18n="save">💾 保存</button>
        <button id="btnReset" class="btn ghost" title="すべてを初期状態に戻す" data-i18n="reset">🔄 リセット</button>
        <button id="btnTheme" class="btn ghost" aria-label="テーマ切り替え" data-i18n="darkTheme">🌙 ダーク</button>
      </div>
      <div class="mobile-actions">
        <button id="btnMenu" class="btn secondary more-btn" aria-haspopup="true" aria-expanded="false" aria-label="メニュー" data-i18n="menu">☰</button>
        <div id="menuDropdown" class="menu-dropdown" hidden>
          <button class="menu-item" data-action="format" data-i18n="formatTool">🧹 整形ツール</button>
          <div class="menu-divider"></div>
          <button class="menu-item" data-action="save" data-i18n="save">💾 保存</button>
          <button class="menu-item" data-action="reset" data-i18n="reset">🔄 リセット</button>
          <button class="menu-item" data-action="theme" id="menuTheme" data-i18n="darkTheme">🌓 テーマ切替</button>
        </div>
      </div>
    </header>

    <div class="card" id="cardA">
      <h3 style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span><span data-i18n="listA">リスト A</span> <span id="countA" class="count-badge">0 行</span></span>
        <button id="btnFormatInline" class="btn ghost sm" title="ごちゃ混ぜを整形して@行だけ抽出" data-i18n="format">🧹 整形</button>
      </h3>
      <textarea id="listA" data-i18n="placeholder" placeholder="1行に1名を貼り付け"></textarea>
      <div class="form-row"><span class="pill"><span data-i18n="points">ポイント</span> <input id="pointsA" type="number" value="1" step="0.1" min="0"></span></div>
    </div>

    <div class="form-row" style="margin:8px 0 16px;">
      <button id="toggleAdvanced" class="btn ghost" data-i18n="showAdvanced">＋ 追加のリスト/除外を表示</button>
    </div>

    <div id="advancedSection" hidden>
      <div class="grid-2">
        <div class="card" id="cardB">
          <h3 style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <span><span data-i18n="listB">リスト B</span> <span id="countB" class="count-badge">0 行</span></span>
            <button id="btnFormatInlineB" class="btn ghost sm" title="リストBを@始まりだけに整形" data-i18n="format">🧹 整形</button>
          </h3>
          <textarea id="listB" data-i18n="placeholder" placeholder="1行に1名を貼り付け"></textarea>
          <div class="form-row"><span class="pill"><span data-i18n="points">ポイント</span> <input id="pointsB" type="number" value="1" step="0.1" min="0"></span></div>
        </div>
        <div class="card" id="cardC">
          <h3 style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <span><span data-i18n="listC">リスト C</span> <span id="countC" class="count-badge">0 行</span></span>
            <button id="btnFormatInlineC" class="btn ghost sm" title="リストCを@始まりだけに整形" data-i18n="format">🧹 整形</button>
          </h3>
          <textarea id="listC" data-i18n="placeholder" placeholder="1行に1名を貼り付け"></textarea>
          <div class="form-row"><span class="pill"><span data-i18n="points">ポイント</span> <input id="pointsC" type="number" value="1" step="0.1" min="0"></span></div>
        </div>
      </div>
      <div class="card exclude" id="cardExclude">
        <h3 style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <span><span data-i18n="excludeList">除外リスト</span> <span class="chip" data-i18n="excludeChip">EXCLUDE</span> <span id="countExclude" class="count-badge">0 行</span></span>
        </h3>
        <textarea id="exclude" data-i18n="excludePlaceholder" placeholder="対象外の名前（1行に1名）"></textarea>
      </div>

      <div hidden><input id="uniquePerList" type="checkbox" checked></div>
    </div>

    <div class="card">
      <h3 data-i18n="lotterySettings">抽選設定</h3>
      <div class="form-row">
        <span class="pill"><span data-i18n="minPoints">最小ポイント</span> <input id="minPoints" type="number" value="1" step="0.1" min="0"></span>
      </div>
      
      <div style="margin-top:16px;">
        <h4 style="margin:0 0 8px 0;" data-i18n="productSettings">商品・景品設定</h4>
        <div id="productsContainer">
          <div class="product-item" data-index="0">
            <div class="form-row">
              <span class="pill"><span data-i18n="productName">商品名</span> <input type="text" class="product-name" value="" data-i18n="productNamePlaceholder" placeholder="空欄で自動設定"></span>
              <span class="pill"><span data-i18n="winners">当選人数</span> <input type="number" class="product-winners" value="1" min="1"></span>
              <button type="button" class="btn ghost remove-product" style="display:none;" data-i18n="removeProduct">削除</button>
            </div>
          </div>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <button id="btnAddProduct" class="btn ghost" data-i18n="addProduct">+ 商品を追加</button>
        </div>
      </div>
      
      <div class="form-row" style="margin-top:16px">
        <button id="btnPreview" class="btn secondary" data-i18n="calculateProbability">確率を計算</button>
        <button id="btnDraw" class="btn primary" data-i18n="draw">抽選する</button>
      </div>
      <div class="statsbar">
        <div id="statsLeft">候補 0 名</div>
        <div id="statsRight">総ポイント 0.00</div>
      </div>
      <div class="table-scroll" id="tableWrap"></div>
    </div>

  <!-- Results Modal -->
  <div class="results-overlay" id="resultsOverlay"></div>
  <div class="results" id="resultsPanel" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
    <button class="close-btn" id="closeResults">×</button>
    <div class="results-header">
      <div class="results-title" id="resultsTitle" data-i18n="noWinners">🎉 当選 0 名</div>
    </div>
    <div class="result-badges" id="winnersBadges"></div>
  </div>

  <!-- Copy Actions (outside modal) -->
  <div class="copy-actions">
    <button id="btnCopyNames" class="copy-btn primary">
      📋
      <span class="btn-text" data-i18n="copyNamesShort">名前をコピー</span>
    </button>
    <button id="btnCopyCSV" class="copy-btn secondary">
      📊
      <span class="btn-text" data-i18n="copyCSVShort">CSVをコピー</span>
    </button>
  </div>

  <!-- ヘルプボタン -->
  <button class="help-toggle" title="使い方を表示">?</button>

  <!-- ヘルプオーバーレイ -->
  <div class="help-overlay" id="helpOverlay">
    <div class="help-content">
      <button class="help-close" onclick="toggleHelp()">&times;</button>
      <div class="help-title" data-i18n="helpTitle">📖 使い方ガイド</div>
      <div class="help-step" data-i18n="helpStep1">1. リスト入力: まずはリストAに参加者名を1行ずつ入力。リストB/Cにも同一参加者名を追加で当選確率アップ。除外も設定可能。B/Cや除外は「＋ 追加のリスト/除外を表示」で開けます。</div>
      <div class="help-step" data-i18n="helpStep2">2. 商品設定: 商品名と当選人数を設定。「+ 商品を追加」で複数商品に対応。</div>
      <div class="help-step" data-i18n="helpStep3">3. 抽選実行: 「抽選する」で開始。結果モーダル隣のボタンから「名前/CSV」をコピーできます。</div>
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);color:var(--muted);font-size:13px">
        <div class="help-step" data-i18n="helpPoints">ポイント設定: 各リストのポイントを入力して当選しやすさを調整。</div>
        <div class="help-step" data-i18n="helpProbability">確率確認: 「確率を計算」で候補者と当選確率を確認。</div>
        <div class="help-step" data-i18n="helpSaveReset">保存/リセット/テーマ: 右上から操作。保存した内容は次回読み込み。</div>
      </div>
    </div>
  </div>

  <!-- 整形ツール オーバーレイ -->
  <div class="format-overlay" id="formatOverlay">
    <div class="format-content">
      <button class="format-close" onclick="(function(){document.getElementById('formatOverlay').classList.remove('show')})()">&times;</button>
      <div class="format-title" data-i18n="formatToolTitle">🧹 リスト整形ツール</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px;" data-i18n="formatDescription">ごちゃ混ぜのテキストから「＠で始まる行」だけを抽出します。</div>
      <textarea id="formatInput" class="format-input" data-i18n="pasteHere" placeholder="ここに貼り付け"></textarea>
      <div class="format-row">
        <label class="pill" style="margin:0;">
          <input id="formatDedupe" type="checkbox" checked> <span data-i18n="removeDuplicates">重複を削除</span>
        </label>
        <button class="btn secondary" onclick="(function(){ if(window.extractAtLines) extractAtLines(); })()" data-i18n="extractAtLines">＠で始まる行だけ抽出</button>
        <button class="btn ghost" onclick="(function(){ const t=document.getElementById('formatInput'); if(t){ t.value=''; t.focus(); } })()" data-i18n="clearInput">入力クリア</button>
      </div>
      <div class="format-label" data-i18n="extractResult">抽出結果</div>
      <textarea id="formatOutput" class="format-output" data-i18n="extractResult" placeholder="抽出結果" readonly></textarea>
      <div class="format-row" style="justify-content:space-between;align-items:center;">
        <div id="formatCount" class="format-count">結果: 0 行</div>
        <button class="btn primary" onclick="(function(){ if(window.copyFormatted) copyFormatted(); })()" data-i18n="copyResult">結果をコピー</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/i18n.js"></script>
  <script src="js/lottery.js"></script>
  <script src="js/features.js"></script>
  <script>
    // アプリケーション初期化
    document.addEventListener('DOMContentLoaded', () => {
      // 多言語システム初期化
      i18n.init();
      
      // メインアプリケーション初期化
      window.lottery = new LotteryApp();
    });
  </script>
</body>
</html>